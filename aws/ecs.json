{
  "Parameters": {
    "Version": {
      "Type": "String",
      "Description": "Version of the follower and leader to deploy"
    },
    "UIVersion": {
      "Type": "String",
      "Default": "e82c309741b18c8c217d1121781e9c1341702b6d",
      "Description": "Version of the ui to deploy"
    },
    "Subnets": {
      "Type": "List<AWS::EC2::Subnet::Id>",
      "Description": "A list of subnets to place the ECS service."
    }
  },
  "Resources": {
    "Cluster": {
      "Type": "AWS::ECS::Cluster",
      "Properties": {
        "CapacityProviders": ["FARGATE"],
        "ClusterName": "SpammerV2Cluster"
      }
    },
    "Task": {
      "Type": "AWS::ECS::TaskDefinition",
      "Properties": {
        "executionRoleArn": "arn:aws:iam::136306849848:role/ecsTaskExecutionRole",
        "containerDefinitions": [
          {
            "environment": [],
            "image": {"Fn::Sub": ["leonpatmore/spammer-v2:${Version}", {"Version": {"Ref": "Version"}}]},
            "essential": true,
            "name": "leader",
            "PortMappings": [{
              "ContainerPort": 5435
            },
            {
              "ContainerPort": 13402
            }]
          },
          {
            "environment": [
              {
                "Name": "SPAMMER_TYPE",
                "Value": "follower"
              },
              {
                "Name": "SPAMMER_PORT",
                "Value": "1234"
              }
            ],
            "image": {"Fn::Sub": ["leonpatmore/spammer-v2:${Version}", {"Version": {"Ref": "Version"}}]},
            "essential": true,
            "name": "follower",
            "PortMappings": [{
              "ContainerPort": 1234
            }]
          },
          {
            "image": "mhausenblas/simpleservice:0.5.0",
            "essential": true,
            "name": "mock-server",
            "PortMappings": [{
              "ContainerPort": 9876
            }]
          },
          {
            "image": {"Fn::Sub": ["leonpatmore/spammer-v2-ui:${Version}", {"Version": {"Ref": "UIVersion"}}]},
            "essential": true,
            "name": "ui",
            "PortMappings": [{
              "ContainerPort": 3000
            }]
          }
        ],
        "memory": "512",
        "family": "spammer-v2-cluster",
        "requiresCompatibilities": [
          "FARGATE"
        ],
        "networkMode": "awsvpc",
        "cpu": "256"
      }
    },
    "SG": {
      "Type" : "AWS::EC2::SecurityGroup",
      "Properties": {
        "GroupDescription": "Allows all access to the ECS service",
        "SecurityGroupIngress": [
          {
            "CidrIp": "0.0.0.0/0",
            "IpProtocol": "-1"
          }
        ]
      }
    },
    "Service": {
      "Type": "AWS::ECS::Service",
      "Properties": {
        "Cluster": {"Fn::GetAtt": ["Cluster", "Arn"]},
        "TaskDefinition": {"Ref": "Task"},
        "LaunchType": "FARGATE",
        "NetworkConfiguration": {
          "AwsvpcConfiguration": {
            "AssignPublicIp": "ENABLED",
            "SecurityGroups": [
              {"Fn::GetAtt": ["SG", "GroupId"]}
            ],
            "Subnets": { "Ref": "Subnets" }
          }
        }
      }
    }
  }
}
