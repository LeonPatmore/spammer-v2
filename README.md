# SpammerV2

[![<LeonPatmore>](https://circleci.com/gh/LeonPatmore/spammer-v2.svg?style=shield)](<LINK>)

## Running

`npm start`

### Environment Variables

Generic variables (applicable for followers and leaders):

- `SPAMMER_PORT`: Port of the server.
- `SPAMMER_HOST`: Host for server to bind to.
- `SPAMMER_TYPE`: Either *follower* or *leader*.

Follower variables:

- `SPAMMER_INITIAL_LEADER_SOCKET_ADDRESS`: [Optional] Socket address of leader to automatically connect to.

## Testing

### Unit Tests

`npm test`

Running an individual test:

`npx jest test/spammer.unit.test.js`

#### Coverage

Coverage results are generated by default in the folder `coverage`.
The following thresholds must be met in order for the command to pass:

```json
"globals": {
    "branches": 70,
    "functions": 80,
    "lines": 80,
    "statements": 80
}
```

The thresholds can be configured in `package.json`.

### Mutation Tests

`npm run mutation`

#### Report

The mutation report is generated in `reports/mutation/html`.

#### Mutation Coverage

Mutation test coverage thresholds are configuered in `stryker.conf.js`:

```text
thresholds: {
    high: 80,
    low: 60,
    break: 50,
}
```

## Static Analysis

`npm run lint`: Run ESLint against all JS code, including the Prettier plugin.

`npx prettier -c **`: Ensures that all files (not just JS files) are correctly formatted. To fix formatting, you can run `npx prettier --write **`.

## API

All paths are prefixed by `/vx`, where `x` is the version number.

### Leader API

#### Get Clients

Get a list of clients connected to this leader.

`POST /vx/clients`

Response:

`200 OK`

```json
{
    "clients": [
        {
            "uuid": "be44c20b-e5e6-40d3-ba07-d1966e158f84",
            "available": true,
            "status": "hi",
            "lastUpdate": "2020-07-18T22:35:33.531Z"
        }
    ]
}
```

#### Add Performance Test

Add a performance test to the queue.

`POST /vx/performance`

Request Body:

```javascript
function runRequest() {
    console.log("hi")
}
module.exports = {
    runtimeSeconds: 5,
    runRequest: runRequest
}
```

Response:

`200 OK`

```json
{
    "test_uuid": "223fe4d4-bbbf-47f0-b1cb-abe0b357d842"
}
```

#### Get Performance Test

Get a performance test .

`GET /vx/performance/{performance_uuid}`

Response:

`200 OK`

```json
{
    "uuid": "223fe4d4-bbbf-47f0-b1cb-abe0b357d842",
    "status": "done",
    "followers": [
        {
            "uuid": "9041a92f-6d44-4b31-aa5d-65851fd32616",
            "available": true,
            "status": "hi",
            "lastUpdate": "2020-07-18T02:38:42.467Z"
        }
    ],
    "run_jobs": [
        {
            "config": {
                "performanceUuid": "223fe4d4-bbbf-47f0-b1cb-abe0b357d842"
            },
            "status": "completed",
            "uuid": "28f0fce9-2f00-4e08-97ac-5eca091c27ed",
            "type": "performance_run",
            "result": {
                "total": 10,
                "success": 10,
                "failed": 0
            }
        }
    ],
    "plan_jobs": [
        {
            "config": {
                "performanceUuid": "223fe4d4-bbbf-47f0-b1cb-abe0b357d842",
                "config": "\r\nfunction runRequest() {\r\n    console.log(\"hi\")\r\n}\r\n\r\nmodule.exports = {\r\n    runtimeSeconds: 5,\r\n    runRequest: runRequest\r\n}\r\n"
            },
            "status": "completed",
            "uuid": "706495ee-91a9-476e-9b59-ddadefc9003e",
            "type": "peformance_plan"
        }
    ],
    "result": {
        "total": 10,
        "success": 10,
        "failed": 0
    }
}
```

### Follower API

#### Connect to a Leader

Connect to a Spammer leader.

`POST /vx/connect`

Request Body:

```json
{
    "socket_address": "localhost:5435"
}
```

Response:

`200 OK`

## Interfaces

### HTTP

#### Configuratiion/Metrics API

Configuration body:

- `method`: The HTTP method to use.
- `url`: The url to send the request to.

Metrics:

- `response_code`: A list of response codes.
- `response_time`: A list of response times in ms.

**Example:**

Configuration body:

```javascript
module.exports = {
    runtimeSeconds: 5,
    interface: 'http',
    method: 'post',
    url: 'http://localhost:5435/123'
}
```

Metrics:

```json
 "result": {
        "response_code": [
            [
                404,
                404,
                404,
                404,
                404,
                404,
                404,
                404,
                404,
                404
            ]
        ],
        "response_time": [
            [
                4,
                6,
                2,
                4,
                4,
                6,
                2,
                3,
                3,
                5
            ]
        ],
        "successful_requests": 10,
        "total_requests": 10
    }
```
